#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
创建测试数据文件 - 包含多种边界测试用例

测试场景：
1. 匹配不到数据的情况
   - 只在数据源A中缺失
   - 只在数据源B中缺失
   - 两个数据源都缺失
   
2. 差额分布场景
   - 差异 = 0（完全相同）
   - 极小差异（< 0.01%）
   - 小差异（0.01% - 1%）
   - 临界值（刚好1%）
   - 中等差异（1% - 10%）
   - 较大差异（10% - 100%）
   - 超大差异（> 100%）
   - 负差异（A < B）
   - 正差异（A > B）
   
3. 特殊值场景
   - B值为0（除零情况）
   - A值为0
   - 两者都为0
   - 大数值
   - 极小数值
   - 负数值
"""

from openpyxl import Workbook


def create_base_file():
    """创建基准匹配列文件（图2格式）"""
    wb = Workbook()
    ws = wb.active
    ws.title = "基准列"
    
    # 表头
    ws.cell(row=1, column=1, value="指标名称")
    
    # 指标名称列表 - 包含各种测试场景
    indicators = [
        # === 正常匹配场景 ===
        "正常_完全相同",           # 差异 = 0
        "正常_极小差异",           # 差异 < 0.01%
        "正常_小差异_正向",        # 0 < 差异 < 1%（绿色）
        "正常_小差异_负向",        # -1% < 差异 < 0（绿色）
        "正常_临界值_刚好1%",      # 差异 = 1%（红色边界）
        "正常_临界值_刚好负1%",    # 差异 = -1%（红色边界）
        "正常_中等差异_5%",        # 差异 = 5%（红色）
        "正常_中等差异_负10%",     # 差异 = -10%（红色）
        "正常_较大差异_50%",       # 差异 = 50%（红色）
        "正常_较大差异_99%",       # 差异 = 99%（红色）
        "正常_超大差异_150%",      # 差异 = 150%（超过100%）
        "正常_超大差异_500%",      # 差异 = 500%（超过100%）
        
        # === 数值特殊场景 ===
        "特殊_大数值",             # 亿级别数值
        "特殊_极小数值",           # 小数点后多位
        "特殊_B值为零",            # 除零情况
        "特殊_A值为零",            # A为0
        "特殊_两者都为零",         # 都为0
        "特殊_负数对比",           # 负数比较
        "特殊_一正一负",           # 正负数比较
        
        # === 匹配缺失场景 ===
        "缺失_仅A有数据",          # B中没有这个指标
        "缺失_仅B有数据",          # A中没有这个指标
        "缺失_两边都没有",         # 两个数据源都没有
        "缺失_A为空值",            # A中有这个指标但值为空
        "缺失_B为空值",            # B中有这个指标但值为空
        "缺失_A为error文本",       # A中值为error字符串
        
        # === 格式测试场景 ===
        "格式_A含逗号",            # A中数值包含逗号格式
        "格式_B含逗号",            # B中数值包含逗号格式
        "格式_都含逗号",           # 两边都是逗号格式
    ]
    
    for row, name in enumerate(indicators, 2):
        ws.cell(row=row, column=1, value=name)
    
    wb.save("test_base.xlsx")
    print("创建: test_base.xlsx（共 {} 个测试指标）".format(len(indicators)))


def create_data_a_file():
    """创建数据源A文件（图3格式 - 横向）"""
    wb = Workbook()
    ws = wb.active
    ws.title = "数据A"
    
    # 横向表头和数据
    # 格式: (指标名称, 值)
    data = [
        # === 正常匹配场景 ===
        ("正常_完全相同", 1000000),                  # 完全相同
        ("正常_极小差异", 1000000.0001),             # 极小差异 0.00001%
        ("正常_小差异_正向", 1005000),               # +0.5%
        ("正常_小差异_负向", 995000),                # -0.5%
        ("正常_临界值_刚好1%", 1010000),             # +1%
        ("正常_临界值_刚好负1%", 990000),            # -1%
        ("正常_中等差异_5%", 1050000),               # +5%
        ("正常_中等差异_负10%", 900000),             # -10%
        ("正常_较大差异_50%", 1500000),              # +50%
        ("正常_较大差异_99%", 1990000),              # +99%
        ("正常_超大差异_150%", 2500000),             # +150%
        ("正常_超大差异_500%", 6000000),             # +500%
        
        # === 数值特殊场景 ===
        ("特殊_大数值", 12345678901234.5678),        # 超大数值
        ("特殊_极小数值", 0.00012345),               # 极小数值
        ("特殊_B值为零", 100),                       # B为0，无法计算百分比
        ("特殊_A值为零", 0),                         # A为0
        ("特殊_两者都为零", 0),                      # 都为0
        ("特殊_负数对比", -500),                     # 负数
        ("特殊_一正一负", 100),                      # 正数
        
        # === 匹配缺失场景 ===
        ("缺失_仅A有数据", 88888.88),                # 只在A中有
        # "缺失_仅B有数据" - 故意不包含在A中
        # "缺失_两边都没有" - 故意不包含在A中
        ("缺失_A为空值", None),                      # A的值为空
        ("缺失_B为空值", 12345.67),                  # A有值，B为空
        ("缺失_A为error文本", "error"),              # A的值是error文本
        
        # === 格式测试场景 ===
        ("格式_A含逗号", "1,234,567.89"),            # A包含逗号格式的字符串
        ("格式_B含逗号", 1234567.89),                # A是数值，B是逗号格式
        ("格式_都含逗号", "9,876,543.21"),           # 两边都是逗号格式
        
        # === 额外的数据（不在基准列中，测试多余数据不影响）===
        ("多余指标_不在基准中", 999999),
    ]
    
    for col, (header, value) in enumerate(data, 1):
        ws.cell(row=1, column=col, value=header)
        ws.cell(row=2, column=col, value=value)
    
    wb.save("test_data_a.xlsx")
    print("创建: test_data_a.xlsx（共 {} 个数据项）".format(len(data)))


def create_data_b_file():
    """创建数据源B文件（图4格式 - 横向）"""
    wb = Workbook()
    ws = wb.active
    ws.title = "数据B"
    
    # 横向表头和数据
    data = [
        # === 正常匹配场景 ===
        ("正常_完全相同", 1000000),                  # 完全相同 → 差异0%
        ("正常_极小差异", 1000000),                  # → 差异0.00001%
        ("正常_小差异_正向", 1000000),               # → 差异+0.5%（绿色）
        ("正常_小差异_负向", 1000000),               # → 差异-0.5%（绿色）
        ("正常_临界值_刚好1%", 1000000),             # → 差异+1%（红色）
        ("正常_临界值_刚好负1%", 1000000),           # → 差异-1%（红色）
        ("正常_中等差异_5%", 1000000),               # → 差异+5%（红色）
        ("正常_中等差异_负10%", 1000000),            # → 差异-10%（红色）
        ("正常_较大差异_50%", 1000000),              # → 差异+50%（红色）
        ("正常_较大差异_99%", 1000000),              # → 差异+99%（红色）
        ("正常_超大差异_150%", 1000000),             # → 差异+150%
        ("正常_超大差异_500%", 1000000),             # → 差异+500%
        
        # === 数值特殊场景 ===
        ("特殊_大数值", 12345678901234.0),           # 大数值比较
        ("特殊_极小数值", 0.00012340),               # 极小数值
        ("特殊_B值为零", 0),                         # B为0，除零场景
        ("特殊_A值为零", 500),                       # A为0，B有值
        ("特殊_两者都为零", 0),                      # 都为0
        ("特殊_负数对比", -400),                     # 负数比较
        ("特殊_一正一负", -100),                     # 正负混合
        
        # === 匹配缺失场景 ===
        # "缺失_仅A有数据" - 故意不包含在B中
        ("缺失_仅B有数据", 77777.77),                # 只在B中有
        # "缺失_两边都没有" - 故意不包含在B中
        ("缺失_A为空值", 54321.00),                  # B有值，A为空
        ("缺失_B为空值", None),                      # B的值为空
        ("缺失_A为error文本", 11111.11),             # B有值，A是error
        
        # === 格式测试场景 ===
        ("格式_A含逗号", 1234500.00),                # B是数值，A是逗号格式
        ("格式_B含逗号", "1,234,500.00"),            # B是逗号格式
        ("格式_都含逗号", "9,876,500.00"),           # 两边都是逗号格式
    ]
    
    for col, (header, value) in enumerate(data, 1):
        ws.cell(row=1, column=col, value=header)
        ws.cell(row=2, column=col, value=value)
    
    wb.save("test_data_b.xlsx")
    print("创建: test_data_b.xlsx（共 {} 个数据项）".format(len(data)))


def print_expected_results():
    """打印预期结果说明"""
    print("\n" + "=" * 70)
    print("预期结果说明")
    print("=" * 70)
    
    expected = [
        ("正常_完全相同", "0", "0%", "绿色"),
        ("正常_极小差异", "0.0001", "0.00001%", "绿色"),
        ("正常_小差异_正向", "5000", "0.5%", "绿色"),
        ("正常_小差异_负向", "-5000", "-0.5%", "绿色"),
        ("正常_临界值_刚好1%", "10000", "1%", "红色"),
        ("正常_临界值_刚好负1%", "-10000", "-1%", "红色"),
        ("正常_中等差异_5%", "50000", "5%", "红色"),
        ("正常_中等差异_负10%", "-100000", "-10%", "红色"),
        ("正常_较大差异_50%", "500000", "50%", "红色"),
        ("正常_较大差异_99%", "990000", "99%", "红色"),
        ("正常_超大差异_150%", "1500000", "150%", "无色(>100%)"),
        ("正常_超大差异_500%", "5000000", "500%", "无色(>100%)"),
        ("特殊_大数值", "0.5678", "极小%", "绿色"),
        ("特殊_极小数值", "0.00000005", "0.04%", "绿色"),
        ("特殊_B值为零", "100", "#VALUE!", "除零错误"),
        ("特殊_A值为零", "-500", "-100%", "红色"),
        ("特殊_两者都为零", "0", "#VALUE!", "除零错误"),
        ("特殊_负数对比", "-100", "-25%", "红色"),
        ("特殊_一正一负", "200", "-200%", "无色(>100%)"),
        ("缺失_仅A有数据", "error", "#VALUE!", "B缺失"),
        ("缺失_仅B有数据", "error", "#VALUE!", "A缺失"),
        ("缺失_两边都没有", "error", "#VALUE!", "都缺失"),
        ("缺失_A为空值", "#VALUE!", "#VALUE!", "A为空"),
        ("缺失_B为空值", "#VALUE!", "#VALUE!", "B为空"),
        ("缺失_A为error文本", "#VALUE!", "#VALUE!", "A为error"),
        ("格式_A含逗号", "67.89", "约0.0055%", "绿色"),
        ("格式_B含逗号", "约-32.11", "约-0.0026%", "绿色"),
        ("格式_都含逗号", "43.21", "约0.0004%", "绿色"),
    ]
    
    print("{:<25} {:<15} {:<15} {}".format("指标名称", "预期差额", "预期百分比", "预期颜色"))
    print("-" * 70)
    for name, diff, pct, color in expected:
        print("{:<25} {:<15} {:<15} {}".format(name, diff, pct, color))


if __name__ == '__main__':
    print("=" * 70)
    print("Excel比对工具 - 测试数据生成器")
    print("=" * 70)
    print()
    
    create_base_file()
    create_data_a_file()
    create_data_b_file()
    
    print("\n" + "=" * 70)
    print("测试数据创建完成！")
    print("=" * 70)
    
    print("\n使用方法：")
    print("python excel_compare_tool.py -b test_base.xlsx -a test_data_a.xlsx -c test_data_b.xlsx -o result.xlsx")
    
    print_expected_results()
    
    print("\n" + "=" * 70)
    print("测试场景覆盖说明")
    print("=" * 70)
    print("""
1. 差异百分比颜色规则测试：
   - 绿色: |差异%| < 1%  （包含0%, 0.5%, -0.5%等）
   - 红色: 1% <= |差异%| <= 100%（包含1%, 5%, 10%, 50%, 99%等）
   - 无色: |差异%| > 100%（包含150%, 500%等）

2. 匹配缺失场景测试：
   - A中缺失指标 → A显示error
   - B中缺失指标 → B显示error
   - 两边都缺失 → 都显示error
   - 值为空/None → 显示error或#VALUE!
   - 值为error文本 → 显示#VALUE!

3. 特殊数值场景测试：
   - 大数值（万亿级别）
   - 极小数值（小数点后8位）
   - 零值和除零场景
   - 负数比较
   - 正负数混合比较

4. 格式兼容性测试：
   - 含逗号的数字字符串（如 "1,234,567.89"）
   - 纯数值与字符串混合
""")
