# 计算逻辑修改说明

## 📋 修改内容

### 1. 差额计算
- **保持不变**: `差额 = A - B`
- **显示**: 列名改为 "差额(A-B)" 更明确

### 2. 百分比计算（重要修改）⭐
**修改前:**
```
差异% = (A-B) / B * 100
```

**修改后:**
```
差异% = (A-B) / A * 100
```

**特殊处理:**
- `A = B` 时: 直接显示 `0%`（绿色）
- `A = 0` 时: 显示 `#VALUE!`（红色，无法计算）

### 3. 小数位数控制（新增）⭐
- **界面新增**: "小数位数" 输入框
- **默认值**: 6位小数
- **范围**: 0-10位
- **应用范围**: 
  - 差额 (A-B)
  - 差异百分比

**示例:**
- 6位: `0.123456%`
- 4位: `0.1235%`
- 2位: `0.12%`

### 4. 颜色阈值逻辑（简化）⭐

**修改前:**
- 绿色: `|差异%| < 1%`
- 红色: `1% ≤ |差异%| ≤ 100%`
- 无色: `|差异%| > 100%`

**修改后:**
- ✅ **绿色**: `A = B` **或** `|差异%| < 阈值`
- ❌ **红色**: 其他所有情况

**关键变化:**
1. 只有两种颜色（绿色/红色），不再有无色
2. A=B 时强制为绿色（即使差异为0也明确标记）
3. 阈值可在界面设置（默认1%）

### 5. 界面优化

**修改前:**
```
颜色阈值设置:
  绿色: < 1.0 %
  红色: 1.0% ≤ 差异 ≤ 100.0%
  无色: > 100%
```

**修改后:**
```
比对设置:
  小数位数: [6] 位
  阈值设置: |差异%| < [1.0] % 或 A=B 时为绿色
  
图例:
  🟢 绿色: A=B 或 |差异%| < 阈值
  🔴 红色: 其他情况
```

## 📊 计算示例

假设阈值 = 1%，小数位数 = 6

| A | B | 差额(A-B) | 差异% | 颜色 | 说明 |
|---|---|----------|-------|------|------|
| 1000 | 1000 | 0.000000 | 0% | 🟢 绿色 | A=B |
| 1005 | 1000 | 5.000000 | 0.497512% | 🟢 绿色 | \|差异%\| < 1% |
| 1010 | 1000 | 10.000000 | 0.990099% | 🟢 绿色 | \|差异%\| < 1% |
| 1015 | 1000 | 15.000000 | 1.477833% | 🔴 红色 | \|差异%\| ≥ 1% |
| 1100 | 1000 | 100.000000 | 9.090909% | 🔴 红色 | \|差异%\| ≥ 1% |
| 2000 | 1000 | 1000.000000 | 50.000000% | 🔴 红色 | \|差异%\| ≥ 1% |
| 500 | 1000 | -500.000000 | -100.000000% | 🔴 红色 | 负差异 |
| 0 | 100 | -100.000000 | #VALUE! | 🔴 红色 | A=0无法计算 |

## 🔍 重要变化对比

### 百分比计算基准的变化

| 场景 | A | B | 旧逻辑 (A-B)/B | 新逻辑 (A-B)/A |
|------|---|---|---------------|---------------|
| 场景1 | 1100 | 1000 | +10% | +9.09% |
| 场景2 | 900 | 1000 | -10% | -11.11% |
| 场景3 | 500 | 1000 | -50% | -100% |
| 场景4 | 2000 | 1000 | +100% | +50% |

**关键差异:**
- 旧逻辑：以B为基准（对比基准）
- 新逻辑：以A为基准（实际值本身）

**适用场景:**
- 新逻辑更适合：表达"A相对于自身有多少差异"
- 例如：实际值 1100，期望值 1000，差异占实际值的 9.09%

## 📝 配置说明

### 前端界面参数

```javascript
decimalPlaces: 6      // 小数位数（默认6）
greenTh: 1.0          // 绿色阈值（默认1%）
```

### 后端处理

```python
# 格式化字符串
format_str = '0.' + '0' * decimal_places
# decimal_places=6 → format_str='0.000000'

# 差额格式化
diff_formatted = float(diff.quantize(Decimal(format_str), rounding=ROUND_HALF_UP))

# 百分比格式化
pct_formatted = float(pct.quantize(Decimal(format_str), rounding=ROUND_HALF_UP))
```

## ✅ 测试验证

### 测试场景

1. **A = B 的情况**
   - 应显示 0%
   - 应为绿色

2. **A = 0 的情况**
   - 应显示 #VALUE!
   - 应为红色

3. **临界值测试**
   - 阈值 = 1%
   - 0.99% 应为绿色
   - 1.00% 应为红色

4. **小数位数测试**
   - 设置 2 位：0.12%
   - 设置 6 位：0.123456%
   - 设置 0 位：0%

5. **负值测试**
   - A < B 时应正常显示负百分比
   - 颜色判断基于绝对值

## 🎯 图例显示

Excel 文件右上角（G1:H2）显示：

```
┌────────────────────────┬──────┐
│ A=B 或 |差异%|<1.0%    │ 绿色 │ ← 绿色背景
├────────────────────────┼──────┤
│ 其他情况               │ 红色 │ ← 红色背景
└────────────────────────┴──────┘
```

## 📖 使用说明

1. **调整小数位数**
   - 在"小数位数"框中输入 0-10
   - 默认 6 位适合大多数场景

2. **调整阈值**
   - 在"阈值设置"框中输入百分比
   - 默认 1.0% 
   - 可根据需求调整，如 0.5% 或 2.0%

3. **运行对比**
   - 点击"开始对比"
   - 查看日志确认设置
   - 打开结果文件查看

## 🔧 后续可能的优化

1. ❓ 是否需要支持"以B为基准"的选项？
2. ❓ 是否需要在图例中显示小数位数？
3. ❓ 是否需要更多颜色等级？（如黄色表示警告）

---

**更新日期:** 2026-01-03  
**版本:** v1.1.0  
**影响范围:** 核心计算逻辑、界面显示、图例说明

